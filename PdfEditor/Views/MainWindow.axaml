<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:PdfEditor.ViewModels"
        xmlns:models="using:PdfEditor.Models"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:ui="using:FluentAvalonia.UI.Controls"
        mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="800"
        x:Class="PdfEditor.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        x:Name="MainWin"
        Title="PDF Editor"
        Width="1200" Height="800"
        ExtendClientAreaToDecorationsHint="True"
        ExtendClientAreaChromeHints="PreferSystemChrome"
        ExtendClientAreaTitleBarHeightHint="40"
        Background="{DynamicResource AppBackgroundBrush}">

    <Design.DataContext>
        <vm:MainWindowViewModel/>
    </Design.DataContext>

    <Grid RowDefinitions="Auto,Auto,Auto,Auto,*,Auto">

        <!-- Menu Bar -->
        <Menu Grid.Row="0" Background="{DynamicResource SecondaryBackgroundBrush}">
            <!-- FILE MENU -->
            <MenuItem Header="_File">
                <MenuItem Header="_Open..." Command="{Binding OpenFileCommand}" InputGesture="Ctrl+O">
                    <MenuItem.Icon><TextBlock Text="ðŸ“"/></MenuItem.Icon>
                </MenuItem>
                <MenuItem Header="{Binding SaveButtonText, StringFormat='_{0}'}" Command="{Binding SaveFileCommand}" InputGesture="Ctrl+S">
                    <MenuItem.Icon><TextBlock Text="ðŸ’¾"/></MenuItem.Icon>
                </MenuItem>
                <MenuItem Header="Save _As..." Command="{Binding SaveAsCommand}" InputGesture="Ctrl+Shift+S"/>
                <Separator/>
                <MenuItem Header="_Recent Files" Name="RecentFilesMenu" SubmenuOpened="RecentFilesMenu_SubmenuOpened"/>
                <Separator/>
                <MenuItem Header="_Close Document" Command="{Binding CloseDocumentCommand}" InputGesture="Ctrl+W"/>
                <MenuItem Header="E_xit" Command="{Binding ExitCommand}" InputGesture="Alt+F4"/>
            </MenuItem>

            <!-- EDIT MENU -->
            <MenuItem Header="_Edit">
                <MenuItem Header="_Find..." Command="{Binding ToggleSearchCommand}" InputGesture="Ctrl+F">
                    <MenuItem.Icon><TextBlock Text="ðŸ”"/></MenuItem.Icon>
                </MenuItem>
                <MenuItem Header="Find _Next" Command="{Binding FindNextCommand}" InputGesture="F3"/>
                <MenuItem Header="Find _Previous" Command="{Binding FindPreviousCommand}" InputGesture="Shift+F3"/>
                <Separator/>
                <MenuItem Header="_Select Text Mode" Command="{Binding ToggleTextSelectionModeCommand}" InputGesture="T">
                    <MenuItem.Icon>
                        <TextBlock Text="âœ“" IsVisible="{Binding IsTextSelectionMode}"/>
                    </MenuItem.Icon>
                </MenuItem>
                <MenuItem Header="_Copy Selected Text" Command="{Binding CopyTextCommand}" InputGesture="Ctrl+C"
                          IsEnabled="{Binding IsTextSelectionMode}"/>
            </MenuItem>

            <!-- DOCUMENT MENU -->
            <MenuItem Header="_Document">
                <MenuItem Header="_Add Pages..." Command="{Binding AddPagesCommand}">
                    <MenuItem.Icon><TextBlock Text="âž•"/></MenuItem.Icon>
                </MenuItem>
                <MenuItem Header="_Remove Current Page" Command="{Binding RemoveCurrentPageCommand}"
                          IsEnabled="{Binding IsDocumentLoaded}">
                    <MenuItem.Icon><TextBlock Text="ðŸ—‘"/></MenuItem.Icon>
                </MenuItem>
                <Separator/>
                <MenuItem Header="Rotate _Left 90Â°" Command="{Binding RotatePageLeftCommand}" InputGesture="Ctrl+L"/>
                <MenuItem Header="Rotate _Right 90Â°" Command="{Binding RotatePageRightCommand}" InputGesture="Ctrl+R"/>
                <MenuItem Header="Rotate _180Â°" Command="{Binding RotatePage180Command}"/>
                <Separator/>
                <MenuItem Header="_Export Pages as Images..." Command="{Binding ExportPagesCommand}"/>
                <MenuItem Header="_Print..." Command="{Binding PrintCommand}" InputGesture="Ctrl+P"/>
            </MenuItem>

            <!-- REDACTION MENU -->
            <MenuItem Header="_Redaction">
                <MenuItem Header="_Enable Redaction Mode" Command="{Binding ToggleRedactionModeCommand}" InputGesture="R">
                    <MenuItem.Icon>
                        <TextBlock Text="âœ“" IsVisible="{Binding IsRedactionMode}"/>
                    </MenuItem.Icon>
                </MenuItem>
                <MenuItem Header="_Apply Redaction" Command="{Binding ApplyRedactionCommand}" InputGesture="Enter"
                          IsEnabled="{Binding IsRedactionMode}">
                    <MenuItem.Icon><TextBlock Text="â¬›" Foreground="Red"/></MenuItem.Icon>
                </MenuItem>
                <Separator/>
                <MenuItem Header="_Verify Redaction" Command="{Binding RunVerifyNowCommand}"
                          IsEnabled="{Binding IsDocumentLoaded}">
                    <MenuItem.Icon><TextBlock Text="âœ“"/></MenuItem.Icon>
                </MenuItem>
                <MenuItem Header="_View Clipboard History">
                    <MenuItem.Icon><TextBlock Text="ðŸ“‹"/></MenuItem.Icon>
                </MenuItem>
            </MenuItem>

            <!-- TOOLS MENU -->
            <MenuItem Header="_Tools">
                <MenuItem Header="_Run OCR on Current Page..." Command="{Binding RunOcrCommand}"
                          IsEnabled="{Binding IsDocumentLoaded}">
                    <MenuItem.Icon><TextBlock Text="ðŸ“"/></MenuItem.Icon>
                </MenuItem>
                <MenuItem Header="Run OCR on _All Pages..." Command="{Binding RunOcrAllPagesCommand}"
                          IsEnabled="{Binding IsDocumentLoaded}"/>
                <Separator/>
                <MenuItem Header="_Verify Digital Signatures..." Command="{Binding VerifySignaturesCommand}"
                          IsEnabled="{Binding IsDocumentLoaded}">
                    <MenuItem.Icon><TextBlock Text="ðŸ”"/></MenuItem.Icon>
                </MenuItem>
                <Separator/>
                <MenuItem Header="_Preferences..." Command="{Binding ShowPreferencesCommand}" InputGesture="Ctrl+,">
                    <MenuItem.Icon><TextBlock Text="âš™"/></MenuItem.Icon>
                </MenuItem>
            </MenuItem>

            <!-- VIEW MENU -->
            <MenuItem Header="_View">
                <MenuItem Header="_Zoom In" Command="{Binding ZoomInCommand}" InputGesture="Ctrl++"/>
                <MenuItem Header="Zoom _Out" Command="{Binding ZoomOutCommand}" InputGesture="Ctrl+-"/>
                <MenuItem Header="_Actual Size" Command="{Binding ZoomActualSizeCommand}" InputGesture="Ctrl+0"/>
                <Separator/>
                <MenuItem Header="Fit _Width" Command="{Binding ZoomFitWidthCommand}" InputGesture="Ctrl+1"/>
                <MenuItem Header="Fit _Page" Command="{Binding ZoomFitPageCommand}" InputGesture="Ctrl+2"/>
                <Separator/>
                <MenuItem Header="Show _Thumbnails">
                    <MenuItem.Icon>
                        <TextBlock Text="âœ“"/>
                    </MenuItem.Icon>
                </MenuItem>
                <MenuItem Header="Show _Clipboard History">
                    <MenuItem.Icon>
                        <TextBlock Text="âœ“"/>
                    </MenuItem.Icon>
                </MenuItem>
            </MenuItem>

            <!-- HELP MENU -->
            <MenuItem Header="_Help">
                <MenuItem Header="_Keyboard Shortcuts" Command="{Binding ShowShortcutsCommand}" InputGesture="F1"/>
                <MenuItem Header="_Documentation" Command="{Binding ShowDocumentationCommand}"/>
                <Separator/>
                <MenuItem Header="_About PDF Editor" Command="{Binding AboutCommand}"/>
            </MenuItem>
        </Menu>

        <!-- Modern Title Bar Area -->
        <Grid Grid.Row="1" Height="40" Background="{DynamicResource ToolbarBackgroundBrush}"
              ColumnDefinitions="Auto,*,Auto">
            <!-- App Icon and Title -->
            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="10" Margin="10,0">
                <TextBlock Text="PDF Editor"
                           FontSize="13"
                           FontWeight="SemiBold"
                           Foreground="{DynamicResource TextPrimaryBrush}"
                           VerticalAlignment="Center"/>
            </StackPanel>

            <!-- Center area for document name -->
            <TextBlock Grid.Column="1"
                       Text="{Binding DocumentName, FallbackValue='No document open'}"
                       FontSize="12"
                       Foreground="{DynamicResource TextSecondaryBrush}"
                       VerticalAlignment="Center"
                       HorizontalAlignment="Center"/>
        </Grid>

        <!-- Simplified Toolbar with Grouped Actions -->
        <Border Grid.Row="1"
                Background="{DynamicResource SecondaryBackgroundBrush}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="0,0,0,1"
                Padding="8,6">
            <Grid ColumnDefinitions="Auto,*,Auto">
                <!-- Left: Main Actions -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="4">
                    <!-- File Group -->
                    <Button Content="ðŸ“ Open" Command="{Binding OpenFileCommand}"
                            Classes="modern-button" Padding="12,6"
                            ToolTip.Tip="Open PDF (Ctrl+O)"/>
                    <Button Content="{Binding SaveButtonText, StringFormat='ðŸ’¾ {0}'}" Command="{Binding SaveFileCommand}"
                            Classes="modern-button" Padding="12,6"
                            ToolTip.Tip="Save (Ctrl+S)"/>

                    <Border Width="1" Height="24" Margin="6,0"
                            Background="{DynamicResource DividerBrush}"/>

                    <!-- Mode Toggles -->
                    <Button Content="ðŸ“ Select Text" Command="{Binding ToggleTextSelectionModeCommand}"
                            Classes="modern-button toggle"
                            Classes.active="{Binding IsTextSelectionMode}"
                            Padding="12,6"
                            ToolTip.Tip="Text Selection Mode (T)"/>

                    <Button Content="â¬› Redact" Command="{Binding ToggleRedactionModeCommand}"
                            Classes="modern-button toggle"
                            Classes.active="{Binding IsRedactionMode}"
                            Padding="12,6"
                            ToolTip.Tip="Redaction Mode (R)"/>

                    <Button Content="âœ“ Apply" Command="{Binding ApplyRedactionCommand}"
                            Classes="modern-button primary"
                            Padding="12,6"
                            IsEnabled="{Binding IsRedactionMode}"
                            IsVisible="{Binding IsRedactionMode}"
                            ToolTip.Tip="Apply Redaction (Enter)"/>

                    <Border Width="1" Height="24" Margin="6,0"
                            Background="{DynamicResource DividerBrush}"/>

                    <!-- Tools Group -->
                    <Button Content="ðŸ” Find" Command="{Binding ToggleSearchCommand}"
                            Classes="modern-button" Padding="12,6"
                            ToolTip.Tip="Find Text (Ctrl+F)"/>

                    <Button Content="ðŸ“ OCR" Command="{Binding RunOcrCommand}"
                            Classes="modern-button" Padding="12,6"
                            IsEnabled="{Binding IsDocumentLoaded}"
                            ToolTip.Tip="Run OCR on Current Page"/>

                    <Border Width="1" Height="24" Margin="6,0"
                            Background="{DynamicResource DividerBrush}"/>

                    <!-- Page Rotation -->
                    <Button Content="â†º" Command="{Binding RotatePageLeftCommand}"
                            Classes="modern-button" Padding="10,6" FontSize="16"
                            ToolTip.Tip="Rotate Left (Ctrl+L)"/>
                    <Button Content="â†»" Command="{Binding RotatePageRightCommand}"
                            Classes="modern-button" Padding="10,6" FontSize="16"
                            ToolTip.Tip="Rotate Right (Ctrl+R)"/>
                </StackPanel>

                <!-- Right: Zoom Controls -->
                <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="4">
                    <Button Content="âˆ’" Command="{Binding ZoomOutCommand}"
                            Classes="modern-button" Padding="10,6" FontWeight="Bold"
                            ToolTip.Tip="Zoom Out (Ctrl+-)"/>
                    <TextBlock Text="{Binding ZoomLevel, StringFormat='{}{0:P0}'}"
                               VerticalAlignment="Center"
                               Foreground="{DynamicResource TextSecondaryBrush}"
                               MinWidth="45" TextAlignment="Center"
                               FontSize="12" FontWeight="Medium"/>
                    <Button Content="+" Command="{Binding ZoomInCommand}"
                            Classes="modern-button" Padding="10,6" FontWeight="Bold"
                            ToolTip.Tip="Zoom In (Ctrl++)"/>
                    <Button Content="Fit" Command="{Binding ZoomFitWidthCommand}"
                            Classes="modern-button" Padding="10,6" FontSize="11"
                            ToolTip.Tip="Fit Width (Ctrl+1)"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Search Bar -->
        <Border Grid.Row="3"
                Background="{DynamicResource SecondaryBackgroundBrush}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="0,0,0,1"
                Padding="8,6"
                IsVisible="{Binding IsSearchVisible}">
            <Grid ColumnDefinitions="Auto,*,Auto,Auto,Auto,Auto,Auto,Auto">
                <!-- Search Label -->
                <TextBlock Grid.Column="0" Text="Find:"
                           VerticalAlignment="Center"
                           Margin="4,0,8,0"
                           FontSize="12"
                           Foreground="{DynamicResource TextSecondaryBrush}"/>

                <!-- Search TextBox -->
                <TextBox Grid.Column="1"
                         Text="{Binding SearchText}"
                         Watermark="Search text..."
                         MinWidth="300"
                         Margin="0,0,8,0"/>

                <!-- Case Sensitive Checkbox -->
                <CheckBox Grid.Column="2"
                          IsChecked="{Binding SearchCaseSensitive}"
                          Content="Case sensitive"
                          Margin="0,0,8,0"/>

                <!-- Whole Words Checkbox -->
                <CheckBox Grid.Column="3"
                          IsChecked="{Binding SearchWholeWords}"
                          Content="Whole words"
                          Margin="0,0,8,0"/>

                <!-- Previous Button -->
                <Button Grid.Column="4"
                        Content="â—€"
                        Command="{Binding FindPreviousCommand}"
                        Classes="modern-button compact"
                        Padding="8,4"
                        Margin="0,0,4,0"
                        ToolTip.Tip="Previous (Shift+F3)"/>

                <!-- Next Button -->
                <Button Grid.Column="5"
                        Content="â–¶"
                        Command="{Binding FindNextCommand}"
                        Classes="modern-button compact"
                        Padding="8,4"
                        Margin="0,0,8,0"
                        ToolTip.Tip="Next (F3)"/>

                <!-- Result Counter -->
                <TextBlock Grid.Column="6"
                           Text="{Binding SearchResultText}"
                           VerticalAlignment="Center"
                           FontSize="12"
                           Foreground="{DynamicResource TextSecondaryBrush}"
                           Margin="0,0,8,0"
                           MinWidth="80"/>

                <!-- Close Button -->
                <Button Grid.Column="7"
                        Content="âœ•"
                        Command="{Binding CloseSearchCommand}"
                        Classes="modern-button compact"
                        Padding="8,4"
                        ToolTip.Tip="Close (Esc)"/>
            </Grid>
        </Border>

        <!-- Main Content Area -->
        <Grid Grid.Row="4" ColumnDefinitions="200,*,250">

            <!-- Thumbnail Sidebar -->
            <Border Grid.Column="0"
                    Background="{DynamicResource SidebarBackgroundBrush}"
                    BorderBrush="{DynamicResource BorderBrush}"
                    BorderThickness="0,0,1,0">
                <ScrollViewer>
                    <ItemsControl ItemsSource="{Binding PageThumbnails}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Button Margin="6" Padding="0" Background="Transparent"
                                        BorderThickness="0"
                                        Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).GoToPageCommand}"
                                        CommandParameter="{Binding PageIndex}"
                                        Cursor="Hand"
                                        Classes.selected="{Binding IsSelected}">
                                    <Border Padding="6"
                                            Background="{DynamicResource CardBrush}"
                                            BorderBrush="{DynamicResource BorderBrush}"
                                            BorderThickness="1"
                                            CornerRadius="6"
                                            Name="ThumbnailBorder">
                                        <StackPanel Spacing="6">
                                            <TextBlock Text="{Binding PageNumber, StringFormat='Page {0}'}"
                                                       HorizontalAlignment="Center"
                                                       FontSize="11"
                                                       FontWeight="Medium"
                                                       Foreground="{DynamicResource TextSecondaryBrush}"/>
                                            <Image Source="{Binding ThumbnailImage}"
                                                   Width="150" Height="200"
                                                   Stretch="Uniform"/>
                                        </StackPanel>
                                    </Border>
                                    <Button.Styles>
                                        <Style Selector="Button.selected > Border">
                                            <Setter Property="BorderBrush" Value="{DynamicResource BrandPrimaryBrush}"/>
                                            <Setter Property="BorderThickness" Value="2"/>
                                            <Setter Property="Background" Value="{DynamicResource SelectedBrush}"/>
                                        </Style>
                                        <Style Selector="Button:pointerover > Border">
                                            <Setter Property="Background" Value="{DynamicResource HoverBrush}"/>
                                        </Style>
                                    </Button.Styles>
                                </Button>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Border>

            <!-- PDF Viewer -->
            <Border Grid.Column="1"
                    Background="{DynamicResource TertiaryBackgroundBrush}"
                    Classes.redactionMode="{Binding IsRedactionMode}">
                <Border.Styles>
                    <Style Selector="Border.redactionMode">
                        <Setter Property="BorderBrush" Value="#E53935"/>
                        <Setter Property="BorderThickness" Value="3"/>
                    </Style>
                </Border.Styles>
                <ScrollViewer x:Name="PdfScrollViewer"
                              HorizontalScrollBarVisibility="Auto"
                              VerticalScrollBarVisibility="Auto"
                              SizeChanged="PdfScrollViewer_SizeChanged">
                    <!-- Container that sizes to the image content, preventing centering offset issues -->
                    <Grid HorizontalAlignment="Left" VerticalAlignment="Top">
                        <!-- PDF Page Image -->
                        <Image x:Name="PdfImage"
                               Source="{Binding CurrentPageImage}"
                               Stretch="None"
                               RenderOptions.BitmapInterpolationMode="HighQuality">
                            <Image.RenderTransform>
                                <ScaleTransform ScaleX="{Binding ZoomLevel}" ScaleY="{Binding ZoomLevel}"/>
                            </Image.RenderTransform>
                        </Image>

                        <!-- Search Highlights Overlay -->
                        <Canvas x:Name="SearchHighlightsCanvas"
                                IsHitTestVisible="False">
                            <Canvas.RenderTransform>
                                <ScaleTransform ScaleX="{Binding ZoomLevel}" ScaleY="{Binding ZoomLevel}"/>
                            </Canvas.RenderTransform>
                        </Canvas>

                        <!-- Applied Redactions Overlay - Shows redactions that have been saved to PDF -->
                        <Canvas x:Name="AppliedRedactionsCanvas"
                                IsHitTestVisible="False">
                            <Canvas.RenderTransform>
                                <ScaleTransform ScaleX="{Binding ZoomLevel}" ScaleY="{Binding ZoomLevel}"/>
                            </Canvas.RenderTransform>
                        </Canvas>

                        <!-- Pending Redactions Overlay - Shows all marked redactions -->
                        <Canvas x:Name="PendingRedactionsCanvas"
                                IsHitTestVisible="False">
                            <Canvas.RenderTransform>
                                <ScaleTransform ScaleX="{Binding ZoomLevel}" ScaleY="{Binding ZoomLevel}"/>
                            </Canvas.RenderTransform>
                        </Canvas>

                        <!-- Redaction Selection Overlay (shown when in redaction mode)
                             COORDINATE SYSTEM: Canvas coordinates are in rendered image pixels (150 DPI).
                             The ScaleTransform ensures the selection rectangle visually aligns with the
                             zoomed image. Mouse events via GetPosition() return coordinates that are
                             automatically inverse-transformed, giving us image-space coordinates. -->
                        <Canvas IsVisible="{Binding IsRedactionMode}"
                                Background="Transparent"
                                Cursor="Cross"
                                PointerPressed="Canvas_PointerPressed"
                                PointerMoved="Canvas_PointerMoved"
                                PointerReleased="Canvas_PointerReleased">
                            <Canvas.RenderTransform>
                                <ScaleTransform ScaleX="{Binding ZoomLevel}" ScaleY="{Binding ZoomLevel}"/>
                            </Canvas.RenderTransform>
                            <!-- Selection Rectangle - semi-transparent black with red dashed border -->
                            <Rectangle x:Name="SelectionRectangle"
                                       Fill="#40000000"
                                       Stroke="Red"
                                       StrokeThickness="2"
                                       StrokeDashArray="5,5"
                                       Canvas.Left="{Binding CurrentRedactionArea.X}"
                                       Canvas.Top="{Binding CurrentRedactionArea.Y}"
                                       Width="{Binding CurrentRedactionArea.Width}"
                                       Height="{Binding CurrentRedactionArea.Height}"/>
                        </Canvas>

                        <!-- Text Selection Overlay (shown when in text selection mode)
                             COORDINATE SYSTEM: Same as Redaction Canvas - image pixels with zoom transform. -->
                        <Canvas IsVisible="{Binding IsTextSelectionMode}"
                                Background="Transparent"
                                PointerPressed="TextCanvas_PointerPressed"
                                PointerMoved="TextCanvas_PointerMoved"
                                PointerReleased="TextCanvas_PointerReleased">
                            <Canvas.RenderTransform>
                                <ScaleTransform ScaleX="{Binding ZoomLevel}" ScaleY="{Binding ZoomLevel}"/>
                            </Canvas.RenderTransform>
                            <!-- Selection Rectangle - semi-transparent green with green dashed border -->
                            <Rectangle x:Name="TextSelectionRectangle"
                                       Fill="#404CAF50"
                                       Stroke="#4CAF50"
                                       StrokeThickness="2"
                                       StrokeDashArray="5,5"
                                       Canvas.Left="{Binding CurrentTextSelectionArea.X}"
                                       Canvas.Top="{Binding CurrentTextSelectionArea.Y}"
                                       Width="{Binding CurrentTextSelectionArea.Width}"
                                       Height="{Binding CurrentTextSelectionArea.Height}"/>
                        </Canvas>
                    </Grid>
                </ScrollViewer>
            </Border>

            <!-- Clipboard History Sidebar -->
            <Border Grid.Column="2"
                    Background="{DynamicResource SidebarBackgroundBrush}"
                    BorderBrush="{DynamicResource BorderBrush}"
                    BorderThickness="1,0,0,0">
                <Grid RowDefinitions="Auto,*,Auto">
                    <!-- Header - Shows "Pending Redactions" in redaction mode, "Clipboard History" otherwise -->
                    <Border Grid.Row="0" Background="{DynamicResource SecondaryBackgroundBrush}"
                            BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="0,0,0,1"
                            Padding="12,10">
                        <Grid ColumnDefinitions="*,Auto">
                            <!-- Title changes based on mode -->
                            <TextBlock Grid.Column="0"
                                       Text="Pending Redactions"
                                       FontWeight="SemiBold"
                                       FontSize="13"
                                       Foreground="{DynamicResource TextPrimaryBrush}"
                                       IsVisible="{Binding IsRedactionMode}"/>
                            <TextBlock Grid.Column="0"
                                       Text="Clipboard History"
                                       FontWeight="SemiBold"
                                       FontSize="13"
                                       Foreground="{DynamicResource TextPrimaryBrush}"
                                       IsVisible="{Binding !IsRedactionMode}"/>
                            <!-- Count badge (only in redaction mode) -->
                            <TextBlock Grid.Column="1"
                                       Text="{Binding RedactionWorkflow.PendingCount, StringFormat='({0})'}"
                                       FontWeight="SemiBold"
                                       FontSize="13"
                                       Foreground="{DynamicResource BrandPrimaryBrush}"
                                       IsVisible="{Binding IsRedactionMode}"/>
                        </Grid>
                    </Border>

                    <!-- Pending Redactions List (visible in redaction mode) -->
                    <ScrollViewer Grid.Row="1" IsVisible="{Binding IsRedactionMode}">
                        <ItemsControl ItemsSource="{Binding RedactionWorkflow.PendingRedactions}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Margin="8" Padding="10"
                                            Background="{DynamicResource CardBrush}"
                                            BorderBrush="#E53935"
                                            BorderThickness="2"
                                            CornerRadius="6">
                                        <StackPanel Spacing="6">
                                            <!-- Header: Page Number -->
                                            <Grid ColumnDefinitions="*,Auto">
                                                <TextBlock Grid.Column="0"
                                                           Text="{Binding PageNumber, StringFormat='Page {0}'}"
                                                           FontSize="11"
                                                           FontWeight="Bold"
                                                           Foreground="{DynamicResource BrandPrimaryBrush}"/>
                                                <Button Grid.Column="1"
                                                        Content="Ã—"
                                                        FontSize="16"
                                                        Padding="4,0"
                                                        Command="{Binding $parent[ItemsControl].((vm:MainWindowViewModel)DataContext).RemovePendingRedactionCommand}"
                                                        CommandParameter="{Binding Id}"
                                                        Background="Transparent"
                                                        Foreground="{DynamicResource TextSecondaryBrush}"/>
                                            </Grid>

                                            <!-- Preview Text -->
                                            <TextBlock Text="{Binding PreviewText}"
                                                       FontSize="11"
                                                       TextWrapping="Wrap"
                                                       MaxHeight="60"
                                                       Foreground="{DynamicResource TextPrimaryBrush}"/>

                                            <!-- Area info -->
                                            <TextBlock Text="{Binding DisplayText}"
                                                       FontSize="10"
                                                       Foreground="{DynamicResource TextTertiaryBrush}"/>
                                        </StackPanel>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>

                    <!-- Action Buttons (visible in redaction mode) -->
                    <Border Grid.Row="2"
                            IsVisible="{Binding IsRedactionMode}"
                            Padding="12"
                            BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="0,1,0,0">
                        <Grid ColumnDefinitions="*,8,*">
                            <!-- Clear All Button -->
                            <Button Grid.Column="0"
                                    Content="Clear All"
                                    Command="{Binding ClearAllRedactionsCommand}"
                                    HorizontalAlignment="Stretch"
                                    Padding="12,8"
                                    FontWeight="SemiBold"
                                    Background="{DynamicResource SecondaryBackgroundBrush}"
                                    Foreground="{DynamicResource TextPrimaryBrush}"
                                    BorderBrush="{DynamicResource BorderBrush}"
                                    BorderThickness="1"/>

                            <!-- Apply All Button -->
                            <Button Grid.Column="2"
                                    Content="Apply All"
                                    Command="{Binding ApplyAllRedactionsCommand}"
                                    HorizontalAlignment="Stretch"
                                    Classes="primary"
                                    Padding="12,8"
                                    FontWeight="SemiBold">
                                <Button.Styles>
                                    <Style Selector="Button.primary">
                                        <Setter Property="Background" Value="#E53935"/>
                                        <Setter Property="Foreground" Value="White"/>
                                    </Style>
                                    <Style Selector="Button.primary:pointerover">
                                        <Setter Property="Background" Value="#D32F2F"/>
                                    </Style>
                                    <Style Selector="Button.primary:disabled">
                                        <Setter Property="Background" Value="#666"/>
                                        <Setter Property="Foreground" Value="#999"/>
                                    </Style>
                                </Button.Styles>
                            </Button>
                        </Grid>
                    </Border>

                    <!-- Clipboard History List (visible when NOT in redaction mode) -->
                    <ScrollViewer Grid.Row="1" IsVisible="{Binding !IsRedactionMode}">
                        <ItemsControl ItemsSource="{Binding ClipboardHistory}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate DataType="models:ClipboardEntry">
                                    <Border Margin="8" Padding="10"
                                            Background="{DynamicResource CardBrush}"
                                            BorderBrush="{DynamicResource BorderBrush}"
                                            BorderThickness="1"
                                            CornerRadius="6"
                                            Classes.redacted="{Binding IsRedacted}">
                                        <Border.Styles>
                                            <Style Selector="Border.redacted">
                                                <Setter Property="BorderBrush" Value="#E53935"/>
                                                <Setter Property="BorderThickness" Value="2"/>
                                            </Style>
                                        </Border.Styles>
                                        <StackPanel Spacing="6">
                                            <!-- Header: Type, Time and Page -->
                                            <Grid ColumnDefinitions="Auto,*,Auto">
                                                <Border Grid.Column="0"
                                                        Background="#E53935"
                                                        CornerRadius="3"
                                                        Padding="6,2"
                                                        Margin="0,0,8,0"
                                                        IsVisible="{Binding IsRedacted}">
                                                    <TextBlock Text="REDACTED"
                                                               FontSize="9"
                                                               FontWeight="Bold"
                                                               Foreground="White"/>
                                                </Border>
                                                <TextBlock Grid.Column="1"
                                                           Text="{Binding TimeDisplay}"
                                                           FontSize="11"
                                                           FontWeight="Medium"
                                                           Foreground="{DynamicResource BrandPrimaryBrush}"/>
                                                <TextBlock Grid.Column="2"
                                                           Text="{Binding PageNumber, StringFormat='Page {0}'}"
                                                           FontSize="11"
                                                           Foreground="{DynamicResource TextSecondaryBrush}"/>
                                            </Grid>

                                            <!-- Preview Text -->
                                            <TextBlock Text="{Binding PreviewText}"
                                                       FontSize="11"
                                                       TextWrapping="Wrap"
                                                       MaxHeight="60"
                                                       Foreground="{DynamicResource TextPrimaryBrush}"/>

                                            <!-- Character Count -->
                                            <TextBlock Text="{Binding CharacterCount, StringFormat='{}{0} characters'}"
                                                       FontSize="10"
                                                       Foreground="{DynamicResource TextTertiaryBrush}"
                                                       HorizontalAlignment="Right"/>
                                        </StackPanel>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Grid>
            </Border>
        </Grid>

        <!-- Status Bar -->
        <Border Grid.Row="5"
                Background="{DynamicResource SecondaryBackgroundBrush}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="0,1,0,0"
                Padding="12,8">
            <Grid ColumnDefinitions="Auto,*,Auto">
                <!-- Mode Indicator -->
                <Border Grid.Column="0"
                        Background="{DynamicResource CardBrush}"
                        CornerRadius="4"
                        Padding="8,4"
                        Margin="0,0,12,0">
                    <TextBlock Text="{Binding CurrentModeText}"
                               VerticalAlignment="Center"
                               FontSize="11"
                               FontWeight="Medium"
                               Foreground="{DynamicResource TextPrimaryBrush}"/>
                </Border>

                <!-- Status Text / Operation Status -->
                <StackPanel Grid.Column="1" Orientation="Vertical" Spacing="2">
                    <!-- Operation Status (shown when an operation is in progress) -->
                    <TextBlock Text="{Binding OperationStatus}"
                               VerticalAlignment="Center"
                               FontSize="12"
                               FontWeight="SemiBold"
                               Foreground="{DynamicResource AccentBrush}"
                               IsVisible="{Binding OperationStatus, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>

                    <!-- Regular Status Text (shown when no operation) -->
                    <TextBlock Text="{Binding StatusBarText}"
                               VerticalAlignment="Center"
                               FontSize="12"
                               Foreground="{DynamicResource TextSecondaryBrush}"
                               IsVisible="{Binding OperationStatus, Converter={x:Static StringConverters.IsNullOrEmpty}}"/>
                </StackPanel>

                <!-- Page Navigation -->
                <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8">
                    <Button Content="â—€" Command="{Binding PreviousPageCommand}"
                            Classes="modern-button compact" Padding="8,4"
                            ToolTip.Tip="Previous Page"/>
                    <TextBlock Text="{Binding DisplayPageNumber, StringFormat='Page {0}'}"
                               VerticalAlignment="Center"
                               FontSize="12"
                               FontWeight="Medium"
                               Foreground="{DynamicResource TextPrimaryBrush}"
                               MinWidth="80"
                               TextAlignment="Center"/>
                    <Button Content="â–¶" Command="{Binding NextPageCommand}"
                            Classes="modern-button compact" Padding="8,4"
                            ToolTip.Tip="Next Page"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</Window>
